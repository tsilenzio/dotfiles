name: Lint

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  shellcheck:
    name: ShellCheck
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Run ShellCheck
        run: |
          files=()
          # Find .sh/.bash files (exclude zsh files handled separately)
          while IFS= read -r -d '' file; do
            files+=("$file")
          done < <(find . -type f \( -name "*.sh" -o -name "*.bash" \) \
            ! -name "*.zsh" ! -name ".zsh*" ! -name "zshrc*" ! -name "zshenv*" \
            ! -name "zprofile*" ! -name "zlogin*" ! -name "zlogout*" -print0)
          # Find extensionless files with bash shebang
          while IFS= read -r -d '' file; do
            [[ "$(basename "$file")" == *.* ]] && continue
            head -1 "$file" 2>/dev/null | grep -qE '#!.*bash' && files+=("$file")
          done < <(find . -type f -executable -print0)
          echo "Checking ${#files[@]} files..."
          shellcheck --severity=warning -x "${files[@]}"

  zsh-syntax:
    name: Zsh Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Zsh
        run: sudo apt-get install -y zsh

      - name: Check Zsh syntax
        run: |
          shopt -s globstar nullglob dotglob
          files=()
          while IFS= read -r -d '' file; do
            files+=("$file")
          done < <(find . -type f \( -name ".zsh*" -o -name "zshrc*" -o -name "zshenv*" -o -name "zprofile*" -o -name "zlogin*" -o -name "zlogout*" -o -name "*.zsh" \) -print0)
          for file in "${files[@]}"; do
            echo "Checking $file..."
            zsh -n "$file"
          done

  python-syntax:
    name: Python Syntax
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Check Python syntax
        run: |
          files=()
          # Find .py files
          while IFS= read -r -d '' file; do
            files+=("$file")
          done < <(find . -type f -name "*.py" -print0)
          # Find extensionless files with python shebang
          while IFS= read -r -d '' file; do
            [[ "$(basename "$file")" == *.* ]] && continue
            head -1 "$file" 2>/dev/null | grep -qE '#!.*python' && files+=("$file")
          done < <(find . -type f -executable -print0)
          for file in "${files[@]}"; do
            echo "Checking $file..."
            python3 -c "import py_compile; py_compile.compile('$file', doraise=True)"
          done
