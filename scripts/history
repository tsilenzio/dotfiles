#!/usr/bin/env bash

set -e

# Show available rollback points
# Usage: ./scripts/history

DOTFILES_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "$DOTFILES_DIR" || exit 1

SNAPSHOT_BASE="$DOTFILES_DIR/.state/snapshots"

echo "Available rollback points:"
echo ""

# Collect tags from all rollback-related prefixes
TAGS=$(git tag -l "pre-update/*" "pre-upgrade/*" "pre-bundle-change/*" "pre-bootstrap/*" "pre-change/*" "pre-conversion/*" "pre-rollback/*" "pre-preview/*" --sort=-creatordate)

if [[ -z "$TAGS" ]]; then
    echo "  No rollback points found."
    echo ""
    echo "Rollback points are created automatically when you run 'rune update' or modify bundles."
    exit 0
fi

echo "$TAGS" | while read -r tag; do
    # Extract timestamp (everything after the last /)
    TIMESTAMP="${tag##*/}"
    # Extract prefix for display
    PREFIX="${tag%/*}"
    HASH=$(git rev-parse --short "$tag")

    # Format timestamp for display
    if [[ "$TIMESTAMP" =~ ^([0-9]{4})([0-9]{2})([0-9]{2})-([0-9]{2})([0-9]{2})([0-9]{2})$ ]]; then
        DISPLAY_DATE="${BASH_REMATCH[1]}-${BASH_REMATCH[2]}-${BASH_REMATCH[3]} ${BASH_REMATCH[4]}:${BASH_REMATCH[5]}:${BASH_REMATCH[6]}"
    else
        DISPLAY_DATE="$TIMESTAMP"
    fi

    # Check what's in the snapshot
    INDICATORS=""
    SNAPSHOT_DIR="$SNAPSHOT_BASE/$TIMESTAMP"
    if [[ -d "$SNAPSHOT_DIR" ]]; then
        [[ -f "$SNAPSHOT_DIR/Brewfile" ]] && INDICATORS+=" [brew]"
        [[ -f "$SNAPSHOT_DIR/bundles" ]] && INDICATORS+=" [bundles]"
    fi

    echo "  $TIMESTAMP  ($HASH)  $DISPLAY_DATE  [$PREFIX]$INDICATORS"
done

echo ""
echo "Usage:"
echo "  rune rollback <timestamp>              # Git-only rollback"
echo "  rune rollback <timestamp> --with-brew  # Also revert packages"
echo "  rune rollback <timestamp> --dry-run    # Preview changes"
